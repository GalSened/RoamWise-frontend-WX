<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoamWise Trip Planning Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .pass { background: #ecfdf5; border-color: #10b981; color: #065f46; }
        .fail { background: #fef2f2; border-color: #ef4444; color: #991b1b; }
        .pending { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .api-test {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .status { margin: 10px 0; font-weight: bold; }
        .json-display {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è RoamWise Trip Planning Functionality Test</h1>
    
    <div class="test-section">
        <h2>1. UI Components Test</h2>
        <div id="ui-test-results"></div>
        <button onclick="testUIComponents()">Test UI Components</button>
    </div>

    <div class="test-section">
        <h2>2. Trip Planning Form Interactions</h2>
        <div id="form-test-results"></div>
        <button onclick="testFormInteractions()">Test Form Interactions</button>
    </div>

    <div class="test-section">
        <h2>3. Backend API Connection Test</h2>
        <div id="api-test-results"></div>
        <button onclick="testBackendAPI()">Test API Connection</button>
        
        <div class="api-test">
            <h4>Manual API Test</h4>
            <p>Test the backend API directly:</p>
            <button onclick="callRecommendAPI()">Call /api/ai/recommend</button>
            <div id="api-response"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>4. Trip Generation Flow Test</h2>
        <div id="generation-test-results"></div>
        <button onclick="testTripGeneration()">Test Trip Generation</button>
    </div>

    <div class="test-section">
        <h2>5. Navigation Test</h2>
        <div id="navigation-test-results"></div>
        <button onclick="testNavigation()">Test Trip Tab Navigation</button>
    </div>

    <script>
        // Test Results Display
        function addTestResult(containerId, testName, status, details) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${status}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${status.toUpperCase()}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            container.appendChild(resultDiv);
        }

        // 1. Test UI Components
        function testUIComponents() {
            const container = document.getElementById('ui-test-results');
            container.innerHTML = '';

            // Open the main app in an iframe to test
            const iframe = document.createElement('iframe');
            iframe.src = '/index.html';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = '1px solid #ccc';
            iframe.style.borderRadius = '8px';
            
            iframe.onload = function() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // Test Trip Tab
                const tripTab = iframeDoc.querySelector('[data-view="trip"]');
                if (tripTab) {
                    addTestResult('ui-test-results', 'Trip Tab Button', 'pass', 'Trip tab found with üó∫Ô∏è icon');
                } else {
                    addTestResult('ui-test-results', 'Trip Tab Button', 'fail', 'Trip tab not found');
                }

                // Test Trip View
                const tripView = iframeDoc.querySelector('#tripView');
                if (tripView) {
                    addTestResult('ui-test-results', 'Trip Planning Interface', 'pass', 'Trip view container found');
                } else {
                    addTestResult('ui-test-results', 'Trip Planning Interface', 'fail', 'Trip view not found');
                }

                // Test Duration Options
                const durationOptions = iframeDoc.querySelectorAll('.duration-option');
                if (durationOptions.length >= 3) {
                    addTestResult('ui-test-results', 'Duration Options', 'pass', `Found ${durationOptions.length} duration options`);
                } else {
                    addTestResult('ui-test-results', 'Duration Options', 'fail', 'Duration options not found or incomplete');
                }

                // Test Interest Options
                const interestOptions = iframeDoc.querySelectorAll('.interest-option');
                if (interestOptions.length >= 4) {
                    addTestResult('ui-test-results', 'Interest Categories', 'pass', `Found ${interestOptions.length} interest options`);
                } else {
                    addTestResult('ui-test-results', 'Interest Categories', 'fail', 'Interest options not found or incomplete');
                }

                // Test Budget Slider
                const budgetSlider = iframeDoc.querySelector('#budgetRange');
                if (budgetSlider) {
                    addTestResult('ui-test-results', 'Budget Slider', 'pass', 'Budget range slider found');
                } else {
                    addTestResult('ui-test-results', 'Budget Slider', 'fail', 'Budget slider not found');
                }

                // Test Generate Button
                const generateBtn = iframeDoc.querySelector('#generateTripBtn');
                if (generateBtn) {
                    const buttonText = generateBtn.textContent;
                    if (buttonText.includes('Generate') || buttonText.includes('Smart Trip')) {
                        addTestResult('ui-test-results', 'Generate Trip Button', 'pass', `Button text: "${buttonText}"`);
                    } else {
                        addTestResult('ui-test-results', 'Generate Trip Button', 'pending', `Unexpected button text: "${buttonText}"`);
                    }
                } else {
                    addTestResult('ui-test-results', 'Generate Trip Button', 'fail', 'Generate button not found');
                }
            };

            container.appendChild(iframe);
        }

        // 2. Test Form Interactions
        function testFormInteractions() {
            const container = document.getElementById('form-test-results');
            container.innerHTML = '';

            // Create test iframe
            const iframe = document.createElement('iframe');
            iframe.src = '/index.html';
            iframe.style.width = '100%';
            iframe.style.height = '500px';
            iframe.style.border = '1px solid #ccc';
            iframe.style.borderRadius = '8px';
            
            iframe.onload = function() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const iframeWindow = iframe.contentWindow;

                // Navigate to trip view first
                setTimeout(() => {
                    const tripNavBtn = iframeDoc.querySelector('[data-view="trip"]');
                    if (tripNavBtn) {
                        tripNavBtn.click();
                        
                        setTimeout(() => {
                            // Test duration selection
                            const durationBtns = iframeDoc.querySelectorAll('.duration-option');
                            if (durationBtns.length > 0) {
                                durationBtns[0].click(); // Click first duration option
                                if (durationBtns[0].classList.contains('selected')) {
                                    addTestResult('form-test-results', 'Duration Selection', 'pass', 'Duration options respond to clicks');
                                } else {
                                    addTestResult('form-test-results', 'Duration Selection', 'fail', 'Duration selection not working');
                                }
                            } else {
                                addTestResult('form-test-results', 'Duration Selection', 'fail', 'Duration buttons not found');
                            }

                            // Test interest selection (max 4)
                            const interestBtns = iframeDoc.querySelectorAll('.interest-option');
                            if (interestBtns.length >= 4) {
                                // Click 4 interests
                                for (let i = 0; i < 4; i++) {
                                    interestBtns[i].click();
                                }
                                const selectedInterests = iframeDoc.querySelectorAll('.interest-option.selected');
                                if (selectedInterests.length === 4) {
                                    addTestResult('form-test-results', 'Interest Selection (Max 4)', 'pass', '4 interests selected successfully');
                                    
                                    // Try to select a 5th one
                                    if (interestBtns[4]) {
                                        interestBtns[4].click();
                                        const selectedAfter = iframeDoc.querySelectorAll('.interest-option.selected');
                                        if (selectedAfter.length === 4) {
                                            addTestResult('form-test-results', 'Interest Limit Enforcement', 'pass', 'Maximum 4 interests enforced');
                                        } else {
                                            addTestResult('form-test-results', 'Interest Limit Enforcement', 'fail', 'More than 4 interests allowed');
                                        }
                                    }
                                } else {
                                    addTestResult('form-test-results', 'Interest Selection (Max 4)', 'fail', `Only ${selectedInterests.length} interests selected`);
                                }
                            } else {
                                addTestResult('form-test-results', 'Interest Selection', 'fail', 'Not enough interest options');
                            }

                            // Test budget slider
                            const budgetSlider = iframeDoc.querySelector('#budgetRange');
                            const budgetAmount = iframeDoc.querySelector('#budgetAmount');
                            if (budgetSlider && budgetAmount) {
                                const originalValue = budgetAmount.textContent;
                                budgetSlider.value = 500;
                                budgetSlider.dispatchEvent(new Event('input'));
                                
                                setTimeout(() => {
                                    if (budgetAmount.textContent === '500') {
                                        addTestResult('form-test-results', 'Budget Slider', 'pass', 'Budget slider updates display correctly');
                                    } else {
                                        addTestResult('form-test-results', 'Budget Slider', 'fail', 'Budget slider not updating display');
                                    }
                                }, 100);
                            } else {
                                addTestResult('form-test-results', 'Budget Slider', 'fail', 'Budget slider or display not found');
                            }
                        }, 500);
                    } else {
                        addTestResult('form-test-results', 'Navigation', 'fail', 'Could not navigate to trip view');
                    }
                }, 500);
            };

            container.appendChild(iframe);
        }

        // 3. Test Backend API
        async function testBackendAPI() {
            const container = document.getElementById('api-test-results');
            container.innerHTML = '<div class="status">Testing API connection...</div>';

            try {
                // Test the AI recommend endpoint
                const response = await fetch('https://premium-hybrid-473405-g7.uc.r.appspot.com/api/ai/recommend', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        preferences: {
                            duration: 'Full day',
                            interests: ['üçΩÔ∏è Food', 'üåø Nature'],
                            budget: 300,
                            destinationType: 'mixed',
                            activities: ['food', 'nature']
                        },
                        context: {
                            userId: 'test_user',
                            location: 'Test Location',
                            requestType: 'trip_planning'
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addTestResult('api-test-results', 'API Connection', 'pass', `Status: ${response.status}, Response received`);
                    
                    if (data.recommendations) {
                        addTestResult('api-test-results', 'AI Recommendations', 'pass', 'Recommendations data present in response');
                    } else {
                        addTestResult('api-test-results', 'AI Recommendations', 'pending', 'No recommendations in response');
                    }

                    if (data.confidence) {
                        addTestResult('api-test-results', 'AI Confidence Score', 'pass', `Confidence: ${data.confidence}%`);
                    }

                    if (data.personalizedInsight) {
                        addTestResult('api-test-results', 'Personalized Insights', 'pass', 'Personalized insights available');
                    }

                } else {
                    addTestResult('api-test-results', 'API Connection', 'fail', `HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                addTestResult('api-test-results', 'API Connection', 'fail', `Connection error: ${error.message}`);
            }
        }

        // Manual API call test
        async function callRecommendAPI() {
            const responseContainer = document.getElementById('api-response');
            responseContainer.innerHTML = '<div class="status">Calling API...</div>';

            try {
                const response = await fetch('https://premium-hybrid-473405-g7.uc.r.appspot.com/api/ai/recommend', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        preferences: {
                            duration: 'Full day',
                            interests: ['üçΩÔ∏è Food', 'üåø Nature', 'üèõÔ∏è Culture'],
                            budget: 300,
                            destinationType: 'mixed',
                            activities: ['food', 'nature', 'culture']
                        },
                        context: {
                            userId: 'manual_test_user',
                            location: 'Current Location',
                            requestType: 'trip_planning'
                        }
                    })
                });

                const data = await response.json();
                responseContainer.innerHTML = `
                    <h4>API Response (Status: ${response.status}):</h4>
                    <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                `;

            } catch (error) {
                responseContainer.innerHTML = `
                    <h4>API Error:</h4>
                    <div class="json-display">Error: ${error.message}</div>
                `;
            }
        }

        // 4. Test Trip Generation Flow
        function testTripGeneration() {
            const container = document.getElementById('generation-test-results');
            container.innerHTML = '';

            // Create test iframe
            const iframe = document.createElement('iframe');
            iframe.src = '/index.html';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = '1px solid #ccc';
            iframe.style.borderRadius = '8px';
            
            iframe.onload = function() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Navigate to trip view and set up form
                setTimeout(() => {
                    const tripNavBtn = iframeDoc.querySelector('[data-view="trip"]');
                    if (tripNavBtn) {
                        tripNavBtn.click();
                        
                        setTimeout(() => {
                            // Set up the form
                            const durationBtns = iframeDoc.querySelectorAll('.duration-option');
                            const interestBtns = iframeDoc.querySelectorAll('.interest-option');
                            const generateBtn = iframeDoc.querySelector('#generateTripBtn');

                            if (durationBtns.length > 0) {
                                durationBtns[1].click(); // Select "Full day"
                            }

                            if (interestBtns.length >= 2) {
                                interestBtns[0].click(); // Select Food
                                interestBtns[1].click(); // Select Nature
                            }

                            if (generateBtn) {
                                addTestResult('generation-test-results', 'Generate Button Setup', 'pass', 'Form configured and generate button found');
                                
                                // Monitor button state changes
                                const originalText = generateBtn.textContent;
                                
                                // Click the generate button
                                generateBtn.click();
                                
                                // Check if button changes to thinking state
                                setTimeout(() => {
                                    const newText = generateBtn.textContent;
                                    if (newText.includes('Thinking') || newText.includes('AI') || generateBtn.disabled) {
                                        addTestResult('generation-test-results', 'Button State Change', 'pass', `Button changed to: "${newText}"`);
                                    } else {
                                        addTestResult('generation-test-results', 'Button State Change', 'pending', `Button text: "${newText}"`);
                                    }

                                    // Check for results after a delay
                                    setTimeout(() => {
                                        const tripDisplay = iframeDoc.querySelector('#enhancedTripDisplay');
                                        if (tripDisplay && tripDisplay.innerHTML.trim() !== '') {
                                            const hasAIContent = tripDisplay.innerHTML.includes('AI') || 
                                                               tripDisplay.innerHTML.includes('o3-mini') ||
                                                               tripDisplay.innerHTML.includes('recommendations');
                                            
                                            if (hasAIContent) {
                                                addTestResult('generation-test-results', 'AI Trip Results', 'pass', 'AI-generated content appears in results');
                                            } else {
                                                addTestResult('generation-test-results', 'AI Trip Results', 'pending', 'Results displayed but no AI content detected');
                                            }
                                        } else {
                                            addTestResult('generation-test-results', 'Trip Results Display', 'fail', 'No results displayed after generation');
                                        }
                                    }, 3000);
                                }, 1000);
                                
                            } else {
                                addTestResult('generation-test-results', 'Generate Button', 'fail', 'Generate button not found');
                            }
                        }, 1000);
                    }
                }, 500);
            };

            container.appendChild(iframe);
        }

        // 5. Test Navigation
        function testNavigation() {
            const container = document.getElementById('navigation-test-results');
            container.innerHTML = '';

            // Create test iframe
            const iframe = document.createElement('iframe');
            iframe.src = '/index.html';
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = '1px solid #ccc';
            iframe.style.borderRadius = '8px';
            
            iframe.onload = function() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                setTimeout(() => {
                    // Test trip tab navigation
                    const tripNavBtn = iframeDoc.querySelector('[data-view="trip"]');
                    const tripView = iframeDoc.querySelector('#tripView');
                    
                    if (tripNavBtn && tripView) {
                        // Check initial state
                        const initiallyVisible = tripView.classList.contains('active');
                        
                        // Click trip tab
                        tripNavBtn.click();
                        
                        setTimeout(() => {
                            const afterClickVisible = tripView.classList.contains('active');
                            
                            if (afterClickVisible) {
                                addTestResult('navigation-test-results', 'Trip Tab Navigation', 'pass', 'Clicking üó∫Ô∏è tab successfully shows trip planning interface');
                                
                                // Check if the tab itself shows as active
                                if (tripNavBtn.classList.contains('active')) {
                                    addTestResult('navigation-test-results', 'Active Tab State', 'pass', 'Trip tab shows active state when selected');
                                } else {
                                    addTestResult('navigation-test-results', 'Active Tab State', 'pending', 'Trip tab may not show active state');
                                }
                            } else {
                                addTestResult('navigation-test-results', 'Trip Tab Navigation', 'fail', 'Trip view not activated after clicking tab');
                            }
                        }, 500);
                    } else {
                        addTestResult('navigation-test-results', 'Trip Navigation Elements', 'fail', 'Trip navigation button or view not found');
                    }
                }, 1000);
            };

            container.appendChild(iframe);
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            console.log('RoamWise Trip Planning Test Suite Ready');
        });
    </script>
</body>
</html>